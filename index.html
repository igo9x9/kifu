<!doctype html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="description" content="単なる棋譜のビューアです">
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@igo9x9" />
    <meta property="og:url" content="https://igo9x9.github.io/kifu/" />
    <meta property="og:title" content="棋譜ビューア" />
    <meta property="og:description" content="単なる棋譜のビューア" />
    <meta property="og:image" content="https://igo9x9.github.io/kifu/twitterimg.png" />
    <title>棋譜ビューア</title>
    <link rel="icon" href="favicon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
    <script src="igo.js"></script>
    <script src="https://misohena.github.io/js_igo/igo_view.js?ver=20200514"></script>
    <link rel="stylesheet" href="https://misohena.github.io/js_igo/igo.css">
    <style>
        .button-success {
            background: rgb(28, 184, 65);
            color: white;
        }
        .pure-button {
            border-radius: 4px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
            width: 100%;
        }
        .hide {
            display: none;
        }
        .text-shadow {
            text-shadow:
            1px 1px 0px #000, -1px -1px 0px #000,
            -1px 1px 0px #000,  1px -1px 0px #000,
            1px 0px 0px #000, -1px  0px 0px #000,
            0px 1px 0px #000,  0px -1px 0px #000;
        }
    </style>
</head>

<div style="max-width: 392px;margin-left:auto;margin-right:auto;margin-bottom:20px;padding: 10px;">
    <div style="padding-left:5px;padding-right:5px;">
        <div id="game-name" style="font-size:1.2rem"></div>
        <div id="player-black" style="font-size:1.2rem"></div>
        <div id="player-white" style="font-size:1.2rem"></div>
        <div id="komi" style="font-size:1.2rem"></div>
        <div id="handycap" style="font-size:1.2rem"></div>
        <div id="result" style="font-size:1.2rem"></div>
    </div>
    <div style="text-align:center; margin-top: 10px;">
        <div id="js-igo"></div>
    </div>

    <div id="new" style="text-align: right;margin-top:20px;" class="hide">
        <a id="newnew" href="#">新しく作る</a>
    </div>

    <div id="hide" class="hide">
        <div style="text-align: center;">
            <textarea id="sgf" rows="20" style="width: 95%;padding:5px;" placeholder="ここにSGFデータを貼り付けてボタンを押すと、棋譜を再生するURLがクリップボードにコピーされます"></textarea>
        </div>
        <button id="copy" class="pure-button pure-button-primary">URLをクリップボードにコピー</button>
    </div>
</div>


<script>

    const params = new URLSearchParams(window.location.search.replace("+", "@"));

    let sgf = "";

    if (params.has("s")) {
        sgf = params.get("s");
    }

    let regex = /GN\[(.*?)\]/g;
    let found = regex.exec(sgf);
    if (found) {
        document.getElementById("game-name").innerText = "対局名：" + found[1];
    }

    regex = /PB\[(.*?)\]/g;
    found = regex.exec(sgf);
    if (found) {
        document.getElementById("player-black").innerText = "黒番　：" + found[1];
    }

    regex = /PW\[(.*?)\]/g;
    found = regex.exec(sgf);
    if (found) {
        document.getElementById("player-white").innerText = "白番　：" + found[1];
    }

    regex = /KM\[(.*?)\]/g;
    found = regex.exec(sgf);
    if (found) {
        document.getElementById("komi").innerText = "コミ　：" + found[1];
    }

    regex = /HA\[(.*?)\]/g;
    found = regex.exec(sgf);
    if (found) {
        document.getElementById("handycap").innerText = "置き石：" + found[1];
    }

    regex = /RE\[(.*?)\]/g;
    found = regex.exec(sgf);
    if (found) {
        const result = found[1];
        console.log(found);
        let text;
        if (result === "0") {
            text = "持碁";
        } else if (result === "B@R") {
            text = "黒中押勝ち";
        } else if (result === "W@R") {
            text = "白中押勝ち";
        } else {
            regex = /B@(.+)/g;
            found = regex.exec(result);
            console.log(found);
            if (found) {
                text = "黒" + found[1] + "目勝ち";
            }　else {
                regex = /W@(.+)/g;
                found = regex.exec(result);
                if (found) {
                    text = "白" + found[1] + "目勝ち";
                }
            }
        }

        if (text) {
            document.getElementById("result").innerText = "結果　：" + text;
        }
    }

    if (sgf.length > 0) {
        const jsIgoGameView = new igo.GameView(
            "js-igo",
            sgf,
            {
                ui:{bottom: ["UndoRedo"]},
                editable: false,
                showMoveNumber: true,
                path: 100,
                gridMargin: 20,
            }
        );    
        jsIgoGameView.fitBoardSizeToWindowAndParent();
        document.getElementById("new").classList.remove("hide");
        const url = "//" + location.host + location.pathname;
        document.getElementById("newnew").href = url;
    } else {
        document.getElementById("hide").classList.remove("hide");
    }


    document.getElementById("copy").addEventListener("click", function() {
        const sgf = document.getElementById("sgf").value;
        const url = location.protocol + "://" + location.host + location.pathname + "?s=" + sgf;

        navigator.clipboard.writeText(url);
        alert("URLをクリップボードにコピーしました。");
    });

</script>

</html>

